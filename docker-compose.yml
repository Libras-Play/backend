services:
  # PostgreSQL para content-service
  postgres:
    image: postgres:15-alpine
    container_name: senas_postgres
    environment:
      POSTGRES_DB: content_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_local_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LocalStack para DynamoDB local
  localstack:
    image: localstack/localstack:3.0
    container_name: senas_localstack
    environment:
      SERVICES: dynamodb,s3,secretsmanager
      DEBUG: 0
      LOCALSTACK_HOST: localstack
      AWS_DEFAULT_REGION: us-east-1
      DISABLE_EVENTS: 1
      SKIP_SSL_CERT_DOWNLOAD: 1
    ports:
      - "4566:4566"
    volumes:
      - "./localstack-data:/var/lib/localstack"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Content Service
  content-service:
    build:
      context: ./services/content-service
      dockerfile: Dockerfile
    container_name: content_service
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres_local_pass@postgres:5432/content_db
      AWS_REGION: us-east-1
      ENVIRONMENT: local
      LOG_LEVEL: DEBUG
      COGNITO_POOL_ID: ""
      COGNITO_CLIENT_ID: ""
      SECRETS_MANAGER_ARN: ""
    ports:
      - "8001:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./services/content-service:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user_service
    environment:
      AWS_REGION: us-east-1
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      DYNAMODB_USERS_TABLE: users
      DYNAMODB_PROGRESS_TABLE: user_progress
      ENVIRONMENT: local
      LOG_LEVEL: DEBUG
      COGNITO_POOL_ID: ""
      COGNITO_CLIENT_ID: ""
    ports:
      - "8002:8000"
    depends_on:
      localstack:
        condition: service_healthy
    volumes:
      - ./services/user-service:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # ML Service
  ml-service:
    build:
      context: ./services/ml-service
      dockerfile: Dockerfile
    container_name: ml_service
    environment:
      AWS_REGION: us-east-1
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_BUCKET: ml-models-local
      SAGEMAKER_ENDPOINT: ""
      ENVIRONMENT: local
      LOG_LEVEL: DEBUG
      MODEL_PATH: /models
    ports:
      - "8003:8000"
    depends_on:
      - localstack
    volumes:
      - ./services/ml-service:/app
      - ml_models:/models
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Inicializador de DynamoDB (crea tablas)
  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: dynamodb_init
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
    depends_on:
      localstack:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
    entrypoint: /bin/sh
    command: >
      -c "
      aws --endpoint-url=http://localstack:4566 dynamodb create-table \
        --table-name users \
        --attribute-definitions AttributeName=user_id,AttributeType=S \
        --key-schema AttributeName=user_id,KeyType=HASH \
        --billing-mode PAY_PER_REQUEST \
        --region us-east-1 || true &&
      aws --endpoint-url=http://localstack:4566 dynamodb create-table \
        --table-name user_progress \
        --attribute-definitions AttributeName=user_id,AttributeType=S AttributeName=exercise_id,AttributeType=S \
        --key-schema AttributeName=user_id,KeyType=HASH AttributeName=exercise_id,KeyType=RANGE \
        --billing-mode PAY_PER_REQUEST \
        --region us-east-1 || true &&
      echo 'DynamoDB tables created successfully'
      "

volumes:
  postgres_data:
  ml_models:

networks:
  default:
    name: senas_network
